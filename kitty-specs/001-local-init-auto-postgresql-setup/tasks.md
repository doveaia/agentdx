# Work Packages: Local Init with Auto PostgreSQL Setup

**Inputs**: Design documents from `/kitty-specs/001-local-init-auto-postgresql-setup/`
**Prerequisites**: plan.md (required), spec.md (user stories), data-model.md

**Tests**: Integration tests included as final work package per stakeholder request.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Config Mode Field & Slug Utility (Priority: P0)

**Goal**: Add `mode` field to config struct and create foundational utilities for the localsetup package.
**Independent Test**: `make build` passes; config struct includes Mode field; ToSlug function converts names correctly.
**Prompt**: `/tasks/WP01-config-mode-and-slug.md`

### Included Subtasks
- [ ] T001 Add `Mode` field (string, yaml:"mode") to Config struct in `config/config.go`
- [ ] T002 Update `DefaultConfig()` to set `Mode: "remote"` as default in `config/config.go`
- [ ] T003 [P] Create `localsetup/interfaces.go` with DockerClient and DatabaseClient interfaces
- [ ] T004 [P] Create `localsetup/slug.go` with `ToSlug(name string) string` function

### Implementation Notes
1. Config change is minimal - add one field, update one function
2. Interfaces define contracts for Docker and DB operations (enables testing)
3. Slug function: lowercase, replace hyphens/spaces with underscores, filter to alphanumeric + underscore only

### Parallel Opportunities
- T003 and T004 can be done in parallel after T001/T002
- T001 and T002 should be done together (same file)

### Dependencies
- None (starting package)

### Risks & Mitigations
- Breaking existing config parsing â†’ YAML handles new fields gracefully, applyDefaults() covers backward compat

---

## Work Package WP02: Docker Container Management (Priority: P1)

**Goal**: Implement Docker CLI wrapper for container lifecycle management.
**Independent Test**: Docker operations work correctly when Docker CLI is available; graceful failure when not.
**Prompt**: `/tasks/WP02-docker-management.md`

### Included Subtasks
- [ ] T005 Create `localsetup/docker.go` with Docker operations:
  - `IsDockerAvailable() bool` - check if docker CLI exists in PATH
  - `ContainerExists(name string) (bool, error)` - docker inspect
  - `ContainerRunning(name string) (bool, error)` - docker inspect with state check
  - `CreateContainer(cfg ContainerConfig) error` - docker run with full config
  - `StartContainer(name string) error` - docker start for stopped containers

### Implementation Notes
1. Use `os/exec` to run Docker commands
2. Use `exec.CommandContext` with timeouts to prevent hangs
3. Container config includes: image, name, env vars, port mapping, restart policy
4. Parse docker inspect JSON output for container state

### Parallel Opportunities
- Can be developed in parallel with WP03 (database setup)

### Dependencies
- Depends on WP01 (interfaces.go for DockerClient interface)

### Risks & Mitigations
- Docker command hangs â†’ Use context with 30s timeout
- Permissions errors â†’ Clear error messages about Docker access

---

## Work Package WP03: Database Setup & Compose Generation (Priority: P1)

**Goal**: Implement PostgreSQL database creation with retry logic and compose.yaml generation.
**Independent Test**: Database created when PostgreSQL reachable; compose.yaml generated with correct content.
**Prompt**: `/tasks/WP03-database-and-compose.md`

### Included Subtasks
- [ ] T006 Create `localsetup/database.go` with PostgreSQL operations:
  - `WaitForPostgres(dsn string, timeout time.Duration) error` - poll with retries
  - `CreateDatabase(dsn, dbName string) error` - CREATE DATABASE IF NOT EXISTS
- [ ] T007 [P] Create `localsetup/compose.go` with compose.yaml generation:
  - `GenerateComposeYAML() string` - return Docker Compose file content
  - `WriteComposeFile(projectRoot string) error` - write to .agentdx/compose.yaml

### Implementation Notes
1. Use `database/sql` with `lib/pq` driver
2. WaitForPostgres: exponential backoff, start at 500ms, max 30s total
3. Connect to `postgres` database first, then CREATE DATABASE
4. Compose template: doveaia/timescaledb:latest-pg17-ts, port 55432, restart always

### Parallel Opportunities
- T006 and T007 are independent and can be done in parallel

### Dependencies
- Depends on WP01 (interfaces.go for DatabaseClient interface)

### Risks & Mitigations
- PostgreSQL slow to start â†’ Retry loop with clear progress messages
- Database already exists â†’ Check before creating, don't error

---

## Work Package WP04: Orchestration & CLI Integration (Priority: P1) ðŸŽ¯ MVP

**Goal**: Wire everything together - main orchestration function and CLI flag integration.
**Independent Test**: `agentdx init --local` runs end-to-end, creates config and database (or shows fallback instructions).
**Prompt**: `/tasks/WP04-orchestration-and-cli.md`

### Included Subtasks
- [ ] T008 Create `localsetup/localsetup.go` with main orchestration:
  - `RunLocalSetup(projectRoot string) (*SetupResult, error)` - orchestrates full flow
  - SetupResult struct with DSN, database name, Docker used flag, etc.
- [ ] T009 Add `--local` / `-l` flag to `cli/init.go` (bool flag)
- [ ] T010 Implement local setup flow in `cli/init.go` when flag is set:
  - Skip all interactive prompts
  - Call `localsetup.RunLocalSetup(cwd)`
  - Configure PostgreSQL FTS settings
  - Set `cfg.Mode = "local"`
  - Always generate compose.yaml
  - Display DSN and instructions when Docker unavailable
- [ ] T011 Update existing init flow in `cli/init.go` to set `Mode = "remote"` when --local not used

### Implementation Notes
1. Orchestration flow: check Docker â†’ create/start container â†’ wait for PG â†’ create DB â†’ generate compose â†’ return result
2. CLI integration: early exit if --local flag set, bypass all prompts
3. Always generate compose.yaml regardless of Docker availability
4. Non-Docker fallback: display DSN, pg_search link, instructions

### Parallel Opportunities
- T008 can be done first, then T009-T011 sequentially (same file modifications)

### Dependencies
- Depends on WP01, WP02, WP03

### Risks & Mitigations
- Breaking existing init behavior â†’ Careful conditional logic, test both paths
- Port 55432 in use â†’ Clear error message with troubleshooting steps

---

## Work Package WP05: Integration Tests (Priority: P2)

**Goal**: Validate the complete feature with integration tests against real Docker.
**Independent Test**: All tests pass; tests skip gracefully when Docker unavailable.
**Prompt**: `/tasks/WP05-integration-tests.md`

### Included Subtasks
- [ ] T012 Create `localsetup/slug_test.go` - test slug generation with various inputs
- [ ] T013 Create `localsetup/docker_test.go` - test Docker detection and operations
- [ ] T014 Create `localsetup/localsetup_test.go` - test full local setup flow
- [ ] T015 Test fallback behavior when Docker unavailable in `localsetup/localsetup_test.go`
- [ ] T016 Test compose.yaml generation in `localsetup/compose_test.go`

### Implementation Notes
1. Use `testing.Short()` to skip Docker tests in quick test runs
2. Check `IsDockerAvailable()` at test start, skip with `t.Skip()` if not available
3. Test slug edge cases: spaces, hyphens, unicode, special chars, empty string
4. Use table-driven tests for slug generation

### Parallel Opportunities
- All test files can be written in parallel

### Dependencies
- Depends on WP04 (all code must be implemented first)

### Risks & Mitigations
- Tests flaky in CI â†’ Use retry logic, proper cleanup after tests
- Container pollution â†’ Use unique test database names, clean up after

---

## Dependency & Execution Summary

```
WP01 (Config + Slug) â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€> WP04 (Orchestration + CLI) â”€â”€> WP05 (Tests)
                          â”‚
WP02 (Docker) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                          â”‚
WP03 (Database + Compose) â”˜
```

- **Sequence**: WP01 â†’ (WP02 || WP03) â†’ WP04 â†’ WP05
- **Parallelization**: WP02 and WP03 can run in parallel after WP01 completes
- **MVP Scope**: WP01 through WP04 constitute the minimal release (tests are polish)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add Mode field to Config struct | WP01 | P0 | No |
| T002 | Update DefaultConfig() with mode: remote | WP01 | P0 | No |
| T003 | Create localsetup/interfaces.go | WP01 | P0 | Yes |
| T004 | Create localsetup/slug.go | WP01 | P0 | Yes |
| T005 | Create localsetup/docker.go | WP02 | P1 | No |
| T006 | Create localsetup/database.go | WP03 | P1 | No |
| T007 | Create localsetup/compose.go | WP03 | P1 | Yes |
| T008 | Create localsetup/localsetup.go | WP04 | P1 | No |
| T009 | Add --local/-l flag to cli/init.go | WP04 | P1 | No |
| T010 | Implement local setup flow | WP04 | P1 | No |
| T011 | Update existing init to set mode: remote | WP04 | P1 | No |
| T012 | Test slug generation | WP05 | P2 | Yes |
| T013 | Test Docker detection | WP05 | P2 | Yes |
| T014 | Test full local setup flow | WP05 | P2 | Yes |
| T015 | Test fallback behavior | WP05 | P2 | Yes |
| T016 | Test compose.yaml generation | WP05 | P2 | Yes |
