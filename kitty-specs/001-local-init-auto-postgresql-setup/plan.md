# Implementation Plan: Local Init with Auto PostgreSQL Setup

**Branch**: `001-local-init-auto-postgresql-setup` | **Date**: 2026-01-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/kitty-specs/001-local-init-auto-postgresql-setup/spec.md`

## Summary

Add `--local` (`-l`) flag to the `agentdx init` command that enables fully non-interactive initialization with automatic PostgreSQL Full Text Search backend setup. When Docker is available, automatically manages `agentdx-postgres` container lifecycle and creates project-specific database. Always generates `.agentdx/compose.yaml` for documentation and backup. When Docker is unavailable, provides manual setup instructions.

## Technical Context

**Language/Version**: Go 1.21+
**Primary Dependencies**: Cobra (CLI), os/exec (Docker commands), database/sql + lib/pq (PostgreSQL)
**Storage**: PostgreSQL 17 with pg_search extensions (TimescaleDB image)
**Testing**: Integration tests against real Docker; skip gracefully when Docker unavailable
**Target Platform**: macOS, Linux (Windows support via WSL)
**Project Type**: Single CLI application
**Performance Goals**: Complete initialization within 60 seconds (excluding Docker image download)
**Constraints**: Must not break existing interactive init behavior
**Scale/Scope**: Single feature addition to existing CLI

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Interface-First Architecture | PASS | New `localsetup` package will define interfaces for Docker and DB operations |
| II. Semantic Search as Primary | N/A | This feature is about initialization, not search |
| III. Code Quality | PENDING | Must pass `make lint` and `make test` after implementation |
| IV. Testing Standards | PASS | Integration tests planned with Docker skip for unavailable environments |
| V. User Experience Consistency | PASS | Follows `command [flags]` pattern, human-readable output with fallback instructions |

**Post-Design Check**: Re-verified after design phase - all gates remain compliant.

## Project Structure

### Documentation (this feature)

```
kitty-specs/001-local-init-auto-postgresql-setup/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Phase 0 research (not needed - requirements clear)
├── data-model.md        # Config structure changes
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks/               # Work packages (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
config/
├── config.go            # MODIFY: Add Mode field to Config struct

cli/
├── init.go              # MODIFY: Add --local/-l flag, integrate localsetup

localsetup/              # NEW PACKAGE
├── localsetup.go        # Main orchestration logic
├── docker.go            # Docker container management (check, create, start)
├── database.go          # PostgreSQL database creation
├── slug.go              # Project name to slug conversion
├── compose.go           # Generate compose.yaml content
├── interfaces.go        # Interfaces for Docker/DB operations
└── localsetup_test.go   # Integration tests

.agentdx/
└── compose.yaml         # GENERATED: Docker compose for manual setup
```

**Structure Decision**: New `localsetup/` package keeps feature-specific logic isolated from core CLI, following interface-first architecture. This enables future extensions (e.g., different container runtimes) and clean testing boundaries.

## Complexity Tracking

*No constitution violations to justify.*

## Implementation Approach

### Phase 1: Config Changes (config/config.go)

1. Add `Mode` field to `Config` struct (type: `string`, yaml: `mode`)
2. Update `DefaultConfig()` to set `mode: "remote"` as default
3. No changes to Load/Save logic needed (YAML handles new field automatically)

### Phase 2: Local Setup Package (localsetup/)

1. **interfaces.go**: Define `DockerClient` and `DatabaseClient` interfaces
2. **slug.go**: Implement `ToSlug(name string) string` - lowercase, replace spaces with underscores, filter to alphanumeric and underscore only
3. **docker.go**: Implement Docker operations
   - `IsDockerAvailable() bool` - check if `docker` CLI exists
   - `ContainerExists(name string) bool` - check if container exists
   - `ContainerRunning(name string) bool` - check if container is running
   - `CreateContainer(name, image string, envVars map[string]string, portMapping string) error`
   - `StartContainer(name string) error`
4. **database.go**: Implement PostgreSQL operations
   - `WaitForPostgres(dsn string, timeout time.Duration) error` - poll with retries
   - `CreateDatabase(dsn, dbName string) error` - CREATE DATABASE IF NOT EXISTS
5. **compose.go**: Implement compose.yaml generation
   - `GenerateComposeYAML(dbName string) string` - return compose file content
6. **localsetup.go**: Main orchestration
   - `RunLocalSetup(projectRoot string) (*SetupResult, error)` - orchestrates entire flow

### Phase 3: CLI Integration (cli/init.go)

1. Add `--local` / `-l` flag (type: bool)
2. When flag is set:
   - Skip all interactive prompts
   - Call `localsetup.RunLocalSetup(cwd)`
   - Set `cfg.Mode = "local"`
   - Configure PostgreSQL FTS settings
   - Save config
3. When flag is not set:
   - Set `cfg.Mode = "remote"` (new default behavior)
   - Continue with existing interactive flow

### Phase 4: Integration Tests

1. Test slug generation with various inputs (spaces, special chars, unicode)
2. Test Docker detection (mock or real)
3. Test full local setup flow when Docker available
4. Test fallback behavior when Docker unavailable
5. Test compose.yaml generation

## Key Design Decisions

1. **Shared Container**: Single `agentdx-postgres` container serves all projects (port 55432). Different projects use different databases within the same PostgreSQL instance.

2. **DSN Format**: `postgres://agentdx:agentdx@localhost:55432/agentdx_<slug>?sslmode=disable`
   - Fixed credentials for local dev (not meant for production)
   - Port 55432 to avoid conflicts with existing PostgreSQL installations

3. **compose.yaml Always Generated**: Provides documentation and manual fallback, regardless of Docker availability.

4. **Graceful Fallback**: When Docker unavailable, don't error - provide helpful output with DSN and instructions.

## Dependencies

- No new external Go dependencies required
- Uses standard library: `os/exec`, `database/sql`, `time`
- Uses existing dependency: `github.com/lib/pq` (already in go.mod for PostgreSQL support)

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Docker command hangs | Use `exec.CommandContext` with timeout |
| PostgreSQL slow to start | Retry loop with 30s timeout, exponential backoff |
| Container already exists with different settings | Reuse existing container, don't modify |
| Port 55432 already in use | Clear error message suggesting alternative |
