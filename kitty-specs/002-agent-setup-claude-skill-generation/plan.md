# Implementation Plan: Agent-Setup Claude Code Skill Generation

**Branch**: `002-agent-setup-claude-skill-generation` | **Date**: 2026-01-14 | **Spec**: `./spec.md`
**Input**: Feature specification from `/kitty-specs/002-agent-setup-claude-skill-generation/spec.md`

## Summary

Enhance the `agent-setup` CLI command to automatically generate a Claude Code skill file at `.claude/skills/agentdx/SKILL.md`. The skill content is dynamically generated based on the configured search type (semantic vs full-text) without exposing database backend details to users.

## Technical Context

**Language/Version**: Go 1.21+
**Primary Dependencies**: cobra (CLI), os/filepath (file operations)
**Storage**: N/A (generates markdown files)
**Testing**: `go test` with existing test patterns
**Target Platform**: Cross-platform CLI (Linux, macOS, Windows)
**Project Type**: Single CLI application
**Performance Goals**: < 1 second for skill generation
**Constraints**: Must be idempotent, backward compatible with existing agent-setup behavior

## Constitution Check

✅ No external dependencies added
✅ Single file modification (agent_setup.go)
✅ Follows existing code patterns (template constants + helper functions)

## Project Structure

### Documentation (this feature)

```
kitty-specs/002-agent-setup-claude-skill-generation/
├── spec.md              # Feature specification
├── plan.md              # This file
└── tasks.md             # Work packages (generated by /spec-kitty.tasks)
```

### Source Code (repository root)

```
cli/
└── agent_setup.go       # MODIFY: Add skill template constants and createSkill function

# Test files (if needed)
cli/
└── agent_setup_test.go  # ADD: Test skill generation (optional)
```

**Structure Decision**: Single file modification - all changes contained in `cli/agent_setup.go` following existing patterns for template constants and file generation.

## Design

### Architecture

The implementation extends the existing `agent-setup` command by:

1. **Adding skill template constants** - Two new template strings for semantic and fulltext skills
2. **Adding createSkill function** - Similar pattern to existing `createSubagent` function
3. **Modifying runAgentSetup** - Call `createSkill()` unconditionally (always create skill)

### Data Flow

```
runAgentSetup()
    │
    ├── Load config → detectSearchType() → "semantic" or "fulltext"
    │
    ├── getTemplates() → Returns appropriate skill template
    │
    ├── [existing] Process agent config files (.cursorrules, CLAUDE.md, etc.)
    │
    ├── [existing] if --with-subagent → createSubagent()
    │
    └── [NEW] createSkill() → Write .claude/skills/agentdx/SKILL.md
```

### Skill Template Content

Two templates needed:

#### Semantic Skill Template (for ollama/openai providers)

```markdown
---
name: agentdx
description: "Replaces ALL built-in search tools for semantic code exploration..."
---

## CRITICAL: Tool Override for Semantic Searches
[Content focused on natural language queries, intent-based search]
```

#### Full-Text Skill Template (for postgres provider)

```markdown
---
name: agentdx
description: "Replaces ALL built-in search tools for keyword-based code search..."
---

## CRITICAL: Tool Override for Keyword Searches
[Content focused on keyword search, parallel queries]
```

### Idempotence Strategy

Use skill marker strings (like existing `agentMarker`, `fullTextMarker`):

```go
const skillMarker = "name: agentdx"  // Frontmatter marker
```

Check if marker exists in file before writing.

### File Structure

```
.claude/
└── skills/
    └── agentdx/
        └── SKILL.md    # Generated skill file
```

## Contracts

### Function Signatures

```go
// createSkill creates the Claude Code skill file at .claude/skills/agentdx/SKILL.md
// Returns nil if file exists and contains skill marker (idempotent)
func createSkill(cwd string, skillTemplate string) error

// Updated getTemplates to return skill template as 5th return value
func getTemplates(searchType string) (instructions, subagent, marker, subagentMarker, skillTemplate string)
```

### Template Constants

```go
const semanticSkillTemplate = `---
name: agentdx
...
`

const fullTextSkillTemplate = `---
name: agentdx
...
`

const skillMarker = "name: agentdx"
```

## Testing Strategy

### Manual Testing

1. Run `agentdx agent-setup` in project with ollama/openai config → verify semantic skill
2. Run `agentdx agent-setup` in project with postgres config → verify fulltext skill
3. Run `agentdx agent-setup` twice → verify idempotent (second run skips)
4. Verify skill file has valid frontmatter and all required sections

### Automated Testing (optional)

If adding `agent_setup_test.go`:
- Test `createSkill` creates file correctly
- Test idempotence (marker detection)
- Test directory creation

## Implementation Notes

1. **Follow existing patterns** - The `createSubagent` function is the model for `createSkill`
2. **No new dependencies** - Uses only standard library (os, filepath, strings)
3. **Output messages** - Print "Created skill: .claude/skills/agentdx/SKILL.md" or "Skill already exists: ..."
4. **Error handling** - Return warnings (like subagent), don't fail the whole command
